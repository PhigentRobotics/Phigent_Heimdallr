# (C) Copyright 2020 - 2021 Xilinx, Inc.
# SPDX-License-Identifier: Apache-2.0

DIR_PRJ = $(shell pwd)
RM = rm -rf
VIVADO_ROOT := $(XILINX_VIVADO)
VIVADO:=${VIVADO_ROOT}/bin/vivado

PLATFORM = /mnt/data-1/workspace/wudi/myprj/kv260-vitis_heimdallr/platforms/xilinx_kv260_phigent_heimdallr_202022_1/kv260_phigent_heimdallr.xpfm

# Kernel name
KERNEL = pp_pipeline_accel
KERNEL_XO = $(KERNEL)/$(KERNEL).xo
TARGET = hw
#---------------------------------------------------------------------
# vitis common setup
.PHONY: help
help::
	@echo ""
	@echo "Makefile Usage:"
	@echo ""
	@echo "make all PLATFORM=<FPGA platform>"
	@echo "Command to generate the xclbin and bit"
	@echo ""
	@echo "make binary_container_1/corr.xo"
	@echo "Command to generate corr.xo"
	@echo ""
	@echo "make clean"
	@echo "Command to remove all the generated files"
	@echo ""

# # v++ flags
VPP ?= v++

XOCC_OPTS = -t ${TARGET} --platform ${PLATFORM} --save-temps --config ${DIR_PRJ}/prj_conf/prj_config_1dpu --xp param:compiler.userPostSysLinkOverlayTcl=${DIR_PRJ}/prj_conf/strip_interconnects.tcl 

dpu_HDLSRCS=kernel_xml/dpu/kernel.xml\
	     scripts/package_dpu_kernel.tcl\
	     scripts/gen_dpu_xo.tcl\
	     ../../dpu_ip/Vitis/dpu/hdl/DPUCZDX8G.v\
	     ../../dpu_ip/Vitis/dpu/inc/arch_def.vh\
	     ../../dpu_ip/Vitis/dpu/xdc/*.xdc\
	     ../../dpu_ip/DPUCZDX8G_*/hdl/DPUCZDX8G_*_dpu.sv\
	     ../../dpu_ip/DPUCZDX8G_*/inc/function.vh\
             ../../dpu_ip/DPUCZDX8G_*/inc/arch_para.vh
			 
corr_HDLSRCS=kernel_xml/corr/kernel.xml\
	     scripts/package_corr.tcl\
	     scripts/gen_corr_xo.tcl\
	     ../../corr_ip/hdl/*.sv\

dpu_TCL=scripts/gen_dpu_xo.tcl
DPU_KERN_NAME = DPUCZDX8G
dpu_xo = binary_container_1/dpu.xo

corr_TCL=scripts/gen_corr_xo.tcl
CORR_KERN_NAME = corr
corr_xo = binary_container_1/corr.xo

XFOPENCV_INCDIR = ../../Vitis_Libraries/vision/L1/include/
KERNEL_XO_FLAGS = -k $(KERNEL) -I$(XFOPENCV_INCDIR) -D__SDSVHLS__ -DHLS_NO_XIL_FPO_LIB --advanced.prop kernel.pp_pipeline_accel.kernel_flags="-std=c++0x"
JOBS = 32
VPP_XO_FLAGS = -t hw --platform $(PLATFORM) \
	--report_level estimate -j $(JOBS) $(KERNEL_XO_FLAGS)

#dpu_pp_xo = $(KERNEL_XO) $(dpu_xo)

#在heimdallr工程中删除pp_pipeline_accel这个ip
dpu_corr_xo = $(dpu_xo) $(corr_xo)

.PHONY: all clean package

all : binary_container_1/dpu.xclbin package

# 	# Rules
$(KERNEL_XO): xf_pp_pipeline_accel.cpp
	@mkdir -p $(@D)
	-@$(RM) $@
	$(VPP) $(VPP_XO_FLAGS) -o $@ $<
	-@$(RM) .Xil

binary_container_1/dpu.xo: $(dpu_HDLSRCS)
	@mkdir -p $(@D)
	-@$(RM) $@
	$(VIVADO) -mode batch -source $(dpu_TCL) -tclargs $@ $(DPU_KERN_NAME) ${TARGET} mpsoc
	
binary_container_1/corr.xo: $(corr_HDLSRCS)
	@mkdir -p $(@D)
	-@$(RM) $@
	$(VIVADO) -mode batch -source $(corr_TCL) -tclargs $@ $(CORR_KERN_NAME) ${TARGET} mpsoc

binary_container_1/dpu.xclbin: $(dpu_corr_xo)
	$(VPP) $(XOCC_OPTS) -l --temp_dir binary_container_1 --log_dir binary_container_1/logs --remote_ip_cache binary_container_1/ip_cache -o "$@" $(+)

package:
	-@mkdir -p binary_container_1/sd_card
	cp ./binary_*/link/vivado/vpl/prj/prj*/sources_1/bd/*/hw_handoff/*.hwh ./binary_*/sd_card
	cp ./binary_*/link/vivado/vpl/prj/prj.gen/sources_1/bd/*/ip/*_DPUCZDX8G_1_0/arch.json ./binary_*/sd_card
	cp ./binary_*/link/int/*.bit ./binary_*/sd_card
	cp ./binary_*/*.xclbin ./binary_*/sd_card
	cp ../../../platforms/ws/kv260_*/hw/*.xsa binary_container_1/sd_card/.

#.PHONY: clean
clean:
	-$(RM) $(KERNEL) *.log _x *.jou v++* *.xclbin *.ini *.xsa
	-$(RM) binary_container_1
	-$(RM) DPU_PP packaged* tmp_*


